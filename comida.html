<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Comidas - Comida Sobrante</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">
            <h1>Comida Sobrante</h1>
            <p>Reduciendo el desperdicio, alimentando el futuro</p>
        </div>
        <nav>
            <ul>
                <li><a href="index.html">Inicio</a></li>
                <li><a href="comida.html">Comidas</a></li>
                <li><a href="pedidos.html">Pedidos</a></li>
                <li><a href="#" onclick="mostrarFormulario()">Agregar Comida</a></li>
            </ul>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <h2>Gestión de Comidas Disponibles</h2>
        <p>Administra y visualiza todas las comidas disponibles en la plataforma</p>
    </section>

    <!-- Filtros -->
    <section class="filters">
        <div class="filter-container">
            <h3>Filtrar por Categoría</h3>
            <select id="filtroCategoria">
                <option value="">Todas las categorías</option>
                <option value="Desayuno">Desayuno</option>
                <option value="Almuerzo">Almuerzo</option>
                <option value="Cena">Cena</option>
                <option value="Postre">Postre</option>
                <option value="Bebida">Bebida</option>
                <option value="Snack">Snack</option>
            </select>
            <button onclick="filtrarComidas()">Filtrar</button>
            <button onclick="cargarComidas()">Mostrar Todas</button>
        </div>
    </section>

    <!-- Lista de Comidas -->
    <section class="comidas-section">
        <div class="comidas-header">
            <h2>Comidas Disponibles</h2>
            <div class="loading" id="loading" style="display: none;">Cargando...</div>
        </div>
        <div class="comidas-grid" id="comidasContainer">
            <!-- Las comidas se cargarán dinámicamente aquí -->
        </div>
    </section>

    <!-- Modal para Agregar/Editar Comida -->
    <div id="modalComida" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarFormulario()">&times;</span>
            <h2 id="tituloModal">Agregar Nueva Comida</h2>
            <form id="formComida">
                <div class="form-group">
                    <label for="nombre">Nombre de la Comida:</label>
                    <input type="text" id="nombre" name="nombre" required>
                </div>
                
                <div class="form-group">
                    <label for="categoria">Categoría:</label>
                    <select id="categoria" name="categoria">
                        <option value="Desayuno">Desayuno</option>
                        <option value="Almuerzo">Almuerzo</option>
                        <option value="Cena">Cena</option>
                        <option value="Postre">Postre</option>
                        <option value="Bebida">Bebida</option>
                        <option value="Snack">Snack</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="precio">Precio (Bs):</label>
                    <input type="number" id="precio" name="precio" step="0.01" min="0" required>
                </div>
                
                <div class="form-actions">
                    <button type="submit" id="btnSubmit">Agregar Comida</button>
                    <button type="button" onclick="cerrarFormulario()">Cancelar</button>
                </div>
                
                <input type="hidden" id="comidaId">
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Comida Sobrante. Proyecto de Responsabilidad Social - Unidad Educativa Padre Jaime Gagnon 1</p>
    </footer>

   <script>
  // === NUEVO: base de la API para prod y local ===
  const API_BASE = location.hostname.endsWith('netlify.app')
    ? 'https://proyecto-comida-backend.onrender.com'  // <-- pon aquí tu dominio del backend (Railway/Render/etc)
    : 'http://localhost:3000';

  let comidas = [];
  let editandoId = null;

  document.addEventListener('DOMContentLoaded', function() {
      cargarComidas();
  });

  // Cargar todas las comidas
  async function cargarComidas() {
      try {
          mostrarLoading(true);
          const response = await fetch(`${API_BASE}/api/comidas`);
          if (!response.ok) throw new Error('Error al cargar comidas');

          const data = await response.json();
          // tu backend devuelve { items, meta }. Aseguramos array:
          comidas = Array.isArray(data) ? data : (data.items || []);
          mostrarComidas(comidas);
      } catch (error) {
          console.error('Error:', error);
          mostrarMensaje('Error al cargar las comidas', 'error');
      } finally {
          mostrarLoading(false);
      }
  }

  // Envío del formulario (crear/actualizar)
  document.getElementById('formComida').addEventListener('submit', async function(e) {
      e.preventDefault();

      const nombre = document.getElementById('nombre').value;
      const categoria = document.getElementById('categoria').value;
      const precio = parseFloat(document.getElementById('precio').value);
      const comidaData = { nombre, categoria, precio };

      try {
          let response;
          if (editandoId) {
              response = await fetch(`${API_BASE}/api/comidas/${editandoId}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(comidaData)
              });
          } else {
              response = await fetch(`${API_BASE}/api/comidas`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(comidaData)
              });
          }

          if (!response.ok) throw new Error('Error al procesar la solicitud');

          mostrarMensaje(editandoId ? 'Comida actualizada exitosamente' : 'Comida agregada exitosamente', 'success');
          cerrarFormulario();
          cargarComidas();
      } catch (error) {
          console.error('Error:', error);
          mostrarMensaje('Error al guardar la comida', 'error');
      }
  });

  // Eliminar
  async function eliminarComida(id) {
      if (!confirm('¿Estás seguro de que quieres eliminar esta comida?')) return;

      try {
          const response = await fetch(`${API_BASE}/api/comidas/${id}`, { method: 'DELETE' });
          if (!response.ok) throw new Error('Error al eliminar');

          mostrarMensaje('Comida eliminada exitosamente', 'success');
          cargarComidas();
      } catch (error) {
          console.error('Error:', error);
          mostrarMensaje('Error al eliminar la comida', 'error');
      }
  }
</script>

</body>
</html>