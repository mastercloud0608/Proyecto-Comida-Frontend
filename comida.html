<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Comidas - Comida Sobrante</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <style>
    /* Estilos adicionales para las imágenes */
    .comida-card {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .comida-image-container {
      width: 100%;
      height: 200px;
      overflow: hidden;
      background: #f0f0f0;
      position: relative;
    }
    
    .comida-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .comida-card:hover .comida-image {
      transform: scale(1.05);
    }
    
    .comida-image-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 3rem;
    }
    
    .form-group.image-preview {
      text-align: center;
    }
    
    .image-preview-container {
      margin-top: 10px;
      max-width: 300px;
      max-height: 200px;
      overflow: hidden;
      border-radius: 8px;
      border: 2px solid #ddd;
      display: inline-block;
    }
    
    .image-preview-container img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .no-image-preview {
      padding: 40px;
      background: #f5f5f5;
      color: #999;
      font-style: italic;
    }

    /* Estilos para el carrito flotante */
    .cart-float {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 15px 20px;
      border-radius: 50px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: bold;
      transition: transform 0.2s;
    }

    .cart-float:hover {
      transform: scale(1.05);
    }

    .cart-badge {
      background: #fff;
      color: #4CAF50;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: bold;
    }

    /* Modal para agregar al carrito */
    .modal-add-cart {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }

    .modal-add-cart-content {
      background: white;
      margin: 10% auto;
      padding: 2rem;
      max-width: 500px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .cantidad-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .cantidad-selector button {
      width: 40px;
      height: 40px;
      border: 2px solid #4CAF50;
      background: white;
      color: #4CAF50;
      font-size: 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cantidad-selector button:hover {
      background: #4CAF50;
      color: white;
    }

    .cantidad-selector span {
      font-size: 1.5rem;
      font-weight: bold;
      min-width: 40px;
      text-align: center;
    }

    .notas-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    .btn-add-cart {
      width: 100%;
      padding: 1rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.125rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 1rem;
    }

    .btn-add-cart:hover {
      background: #45a049;
    }

    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 10000;
      animation: slideIn 0.3s ease;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">
      <h1>Comida Sobrante</h1>
      <p>Reduciendo el desperdicio, alimentando el futuro</p>
    </div>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="comida.html">Comidas</a></li>
        <li><a href="pedidos.html">Pedidos</a></li>
        <li><a href="#" onclick="mostrarFormulario()">Agregar Comida</a></li>
        <li><a href="carrito.html">🛒 Carrito (<span id="navCartCount">0</span>)</a></li>
      </ul>
    </nav>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <h2>Gestión de Comidas Disponibles</h2>
    <p>Administra y visualiza todas las comidas disponibles en la plataforma</p>
  </section>

  <!-- Filtros -->
  <section class="filters">
    <div class="filter-container">
      <h3>Filtrar por Categoría</h3>
      <select id="filtroCategoria">
        <option value="">Todas las categorías</option>
        <option value="Desayuno">Desayuno</option>
        <option value="Almuerzo">Almuerzo</option>
        <option value="Cena">Cena</option>
        <option value="Postre">Postre</option>
        <option value="Bebida">Bebida</option>
        <option value="Snack">Snack</option>
      </select>
      <button onclick="filtrarComidas()">Filtrar</button>
      <button onclick="cargarComidas()">Mostrar Todas</button>
    </div>
  </section>

  <!-- Lista de Comidas -->
  <section class="comidas-section">
    <div class="comidas-header">
      <h2>Comidas Disponibles</h2>
      <div class="loading" id="loading" style="display:none;">Cargando...</div>
    </div>
    <div class="comidas-grid" id="comidasContainer"></div>
  </section>

  <!-- Carrito Flotante -->
  <div class="cart-float" onclick="window.location.href='carrito.html'">
    🛒
    <span>Ver Carrito</span>
    <div class="cart-badge" id="floatCartCount">0</div>
  </div>

  <!-- Modal para Agregar/Editar Comida -->
  <div id="modalComida" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarFormulario()">&times;</span>
      <h2 id="tituloModal">Agregar Nueva Comida</h2>
      <form id="formComida">
        <div class="form-group">
          <label for="nombre">Nombre de la Comida:</label>
          <input type="text" id="nombre" name="nombre" required>
        </div>
        <div class="form-group">
          <label for="categoria">Categoría:</label>
          <select id="categoria" name="categoria">
            <option value="Desayuno">Desayuno</option>
            <option value="Almuerzo">Almuerzo</option>
            <option value="Cena">Cena</option>
            <option value="Postre">Postre</option>
            <option value="Bebida">Bebida</option>
            <option value="Snack">Snack</option>
          </select>
        </div>
        <div class="form-group">
          <label for="precio">Precio (Bs):</label>
          <input type="number" id="precio" name="precio" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="imagen">URL de la Imagen:</label>
          <input type="url" id="imagen" name="imagen" placeholder="https://ejemplo.com/imagen.jpg">
          <small>Ingresa la URL completa de la imagen (opcional)</small>
        </div>
        <div class="form-group image-preview">
          <div class="image-preview-container" id="imagePreviewContainer">
            <div class="no-image-preview">Vista previa de la imagen</div>
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" id="btnSubmit">Agregar Comida</button>
          <button type="button" onclick="cerrarFormulario()">Cancelar</button>
        </div>
        <input type="hidden" id="comidaId">
      </form>
    </div>
  </div>

  <!-- Modal para Agregar al Carrito -->
  <div id="modalAddCart" class="modal-add-cart">
    <div class="modal-add-cart-content">
      <h2>Agregar al Carrito</h2>
      <div id="modalCartContent"></div>
      <div class="form-group">
        <label>Cantidad:</label>
        <div class="cantidad-selector">
          <button type="button" onclick="cambiarCantidadModal(-1)">−</button>
          <span id="cantidadModal">1</span>
          <button type="button" onclick="cambiarCantidadModal(1)">+</button>
        </div>
      </div>
      <div class="form-group">
        <label for="notasModal">Notas especiales (opcional):</label>
        <textarea id="notasModal" class="notas-textarea" placeholder="Ej: Sin cebolla, extra picante, etc."></textarea>
      </div>
      <button class="btn-add-cart" onclick="confirmarAgregarCarrito()">Agregar al Carrito</button>
      <button type="button" onclick="cerrarModalCart()" style="width: 100%; padding: 0.75rem; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 0.5rem;">Cancelar</button>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 Comida Sobrante. Proyecto de Responsabilidad Social - Unidad Educativa Padre Jaime Gagnon 1</p>
  </footer>

  <script>
    // === BASE API (prod/local) ===
    const API_BASE = location.hostname.endsWith('netlify.app')
      ? 'https://proyecto-comida-backend.onrender.com'
      : 'http://localhost:3000';

    let comidas = [];
    let editandoId = null;
    let comidaSeleccionada = null;
    let cantidadModal = 1;

    // Session ID para el carrito
    let sessionId = localStorage.getItem('session_id') || generateSessionId();

    function generateSessionId() {
      const id = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('session_id', id);
      return id;
    }

    const asArray = (data) => Array.isArray(data) ? data : (data?.items || []);

    document.addEventListener('DOMContentLoaded', () => {
      cargarComidas();
      actualizarContadorCarrito();
      
      // Preview de imagen en tiempo real
      document.getElementById('imagen').addEventListener('input', (e) => {
        actualizarPreviewImagen(e.target.value);
      });
    });

    // Loading helper
    function mostrarLoading(mostrar) {
      const el = document.getElementById('loading');
      if (el) el.style.display = mostrar ? 'block' : 'none';
    }

    // Mensajes
    function mostrarMensaje(mensaje, tipo='info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert ${tipo}`;
      alertDiv.textContent = mensaje;
      document.body.insertBefore(alertDiv, document.body.firstChild);
      setTimeout(() => alertDiv.remove(), 3000);
    }

    // Preview de imagen
    function actualizarPreviewImagen(url) {
      const container = document.getElementById('imagePreviewContainer');
      if (!url || url.trim() === '') {
        container.innerHTML = '<div class="no-image-preview">Vista previa de la imagen</div>';
        return;
      }
      
      const img = document.createElement('img');
      img.src = url;
      img.alt = 'Preview';
      img.onerror = () => {
        container.innerHTML = '<div class="no-image-preview">⚠️ URL de imagen no válida</div>';
      };
      img.onload = () => {
        container.innerHTML = '';
        container.appendChild(img);
      };
    }

    // Cargar todas las comidas
    async function cargarComidas() {
      try {
        mostrarLoading(true);
        const resp = await fetch(`${API_BASE}/api/comidas`);
        if (!resp.ok) throw new Error('Error al cargar comidas');
        const data = await resp.json();
        comidas = asArray(data);
        mostrarComidas(comidas);
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error al cargar las comidas', 'error');
      } finally {
        mostrarLoading(false);
      }
    }

    // Render
    function mostrarComidas(comidasArray) {
      const container = document.getElementById('comidasContainer');
      if (!comidasArray.length) {
        container.innerHTML = '<div class="no-results">No hay comidas disponibles</div>';
        return;
      }
      container.innerHTML = comidasArray.map(comida => {
        const categoria = comida.categoria || 'Sin categoría';
        const badgeClass = (comida.categoria || 'default').toLowerCase();
        const precio = (comida.precio != null) ? Number(comida.precio) : 0;
        
        // Imagen o placeholder
        const imagenHtml = comida.imagen 
          ? `<img src="${comida.imagen}" alt="${comida.nombre}" class="comida-image" onerror="this.parentElement.innerHTML='<div class=\\'comida-image-placeholder\\'>🍽️</div>'">` 
          : `<div class="comida-image-placeholder">🍽️</div>`;
        
        return `
          <div class="comida-card">
            <div class="comida-image-container">
              ${imagenHtml}
            </div>
            <div class="comida-header">
              <h3>${comida.nombre}</h3>
              <span class="categoria-badge ${badgeClass}">${categoria}</span>
            </div>
            <div class="comida-info">
              <div class="precio">Bs ${precio.toFixed(2)}</div>
              <div class="comida-id">ID: ${comida.id}</div>
            </div>
            <div class="comida-actions">
              <button class="btn-edit" onclick="editarComida(${comida.id})">Editar</button>
              <button class="btn-delete" onclick="eliminarComida(${comida.id})">Eliminar</button>
              <button class="btn-order" onclick="abrirModalCart(${comida.id})">🛒 Agregar</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Filtro
    function filtrarComidas() {
      const filtro = document.getElementById('filtroCategoria').value;
      const arr = filtro ? comidas.filter(c => c.categoria === filtro) : comidas;
      mostrarComidas(arr);
    }

    // Formulario Admin
    function mostrarFormulario(comida=null) {
      const modal = document.getElementById('modalComida');
      const titulo = document.getElementById('tituloModal');
      const btnSubmit = document.getElementById('btnSubmit');
      const form = document.getElementById('formComida');

      if (comida) {
        titulo.textContent = 'Editar Comida';
        btnSubmit.textContent = 'Actualizar Comida';
        document.getElementById('comidaId').value = comida.id;
        document.getElementById('nombre').value = comida.nombre;
        document.getElementById('categoria').value = comida.categoria || '';
        document.getElementById('precio').value = comida.precio;
        document.getElementById('imagen').value = comida.imagen || '';
        actualizarPreviewImagen(comida.imagen || '');
        editandoId = comida.id;
      } else {
        titulo.textContent = 'Agregar Nueva Comida';
        btnSubmit.textContent = 'Agregar Comida';
        form.reset();
        actualizarPreviewImagen('');
        editandoId = null;
      }
      modal.style.display = 'block';
    }

    function cerrarFormulario() {
      document.getElementById('modalComida').style.display = 'none';
      document.getElementById('formComida').reset();
      actualizarPreviewImagen('');
      editandoId = null;
    }

    // Submit crear/editar
    document.getElementById('formComida').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nombre = document.getElementById('nombre').value;
      const categoria = document.getElementById('categoria').value;
      const precio = parseFloat(document.getElementById('precio').value);
      const imagen = document.getElementById('imagen').value.trim();
      
      const comidaData = { 
        nombre, 
        categoria, 
        precio,
        imagen: imagen || null
      };

      try {
        let resp;
        if (editandoId) {
          resp = await fetch(`${API_BASE}/api/comidas/${editandoId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(comidaData)
          });
        } else {
          resp = await fetch(`${API_BASE}/api/comidas`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(comidaData)
          });
        }
        if (!resp.ok) throw new Error('Error al procesar la solicitud');
        mostrarMensaje(editandoId ? 'Comida actualizada exitosamente' : 'Comida agregada exitosamente', 'success');
        cerrarFormulario();
        cargarComidas();
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error al guardar la comida', 'error');
      }
    });

    // Editar
    function editarComida(id) {
      const comida = comidas.find(c => c.id === id);
      if (comida) mostrarFormulario(comida);
    }

    // Eliminar
    async function eliminarComida(id) {
      if (!confirm('¿Estás seguro de que quieres eliminar esta comida?')) return;
      try {
        const resp = await fetch(`${API_BASE}/api/comidas/${id}`, { method: 'DELETE' });
        if (!resp.ok) throw new Error('Error al eliminar');
        mostrarMensaje('Comida eliminada exitosamente', 'success');
        cargarComidas();
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error al eliminar la comida', 'error');
      }
    }

    // ===== FUNCIONES DEL CARRITO =====

    // Actualizar contador del carrito
    async function actualizarContadorCarrito() {
      try {
        const resp = await fetch(`${API_BASE}/api/carrito`, {
          headers: { 'x-session-id': sessionId }
        });
        if (resp.ok) {
          const carrito = await resp.json();
          const total = carrito.items?.reduce((sum, item) => sum + item.cantidad, 0) || 0;
          document.getElementById('navCartCount').textContent = total;
          document.getElementById('floatCartCount').textContent = total;
        }
      } catch (err) {
        console.error('Error al actualizar contador:', err);
      }
    }

    // Abrir modal para agregar al carrito
    function abrirModalCart(comidaId) {
      const comida = comidas.find(c => c.id === comidaId);
      if (!comida) return;

      comidaSeleccionada = comida;
      cantidadModal = 1;

      const imagenHtml = comida.imagen 
        ? `<img src="${comida.imagen}" alt="${comida.nombre}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;">` 
        : `<div style="width: 100%; height: 150px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 3rem; border-radius: 8px; margin-bottom: 1rem;">🍽️</div>`;

      document.getElementById('modalCartContent').innerHTML = `
        ${imagenHtml}
        <h3 style="margin: 0 0 0.5rem 0;">${comida.nombre}</h3>
        <p style="color: #666; margin: 0 0 0.5rem 0;"><strong>Categoría:</strong> ${comida.categoria}</p>
        <p style="font-size: 1.5rem; color: #4CAF50; font-weight: bold; margin: 0;">Bs ${Number(comida.precio).toFixed(2)}</p>
      `;
      
      document.getElementById('cantidadModal').textContent = cantidadModal;
      document.getElementById('notasModal').value = '';
      document.getElementById('modalAddCart').style.display = 'block';
    }

    function cerrarModalCart() {
      document.getElementById('modalAddCart').style.display = 'none';
      comidaSeleccionada = null;
      cantidadModal = 1;
    }

    function cambiarCantidadModal(delta) {
      cantidadModal = Math.max(1, cantidadModal + delta);
      document.getElementById('cantidadModal').textContent = cantidadModal;
    }

    // Confirmar agregar al carrito
    async function confirmarAgregarCarrito() {
      if (!comidaSeleccionada) return;

      const notas = document.getElementById('notasModal').value.trim();

      try {
        const resp = await fetch(`${API_BASE}/api/carrito/items`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-session-id': sessionId
          },
          body: JSON.stringify({
            comida_id: comidaSeleccionada.id,
            cantidad: cantidadModal,
            notas: notas || null
          })
        });

        if (!resp.ok) throw new Error('Error al agregar al carrito');

        mostrarMensaje(`${comidaSeleccionada.nombre} agregado al carrito`, 'success');
        cerrarModalCart();
        actualizarContadorCarrito();
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error al agregar al carrito', 'error');
      }
    }

    // Cerrar modal al hacer click fuera
    window.onclick = function (event) {
      const modal = document.getElementById('modalComida');
      const modalCart = document.getElementById('modalAddCart');
      if (event.target === modal) cerrarFormulario();
      if (event.target === modalCart) cerrarModalCart();
    };
  </script>
</body>
</html>