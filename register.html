<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Comida Sobrante</title>
    <link rel="stylesheet" href="assets/styles.css">
    <style>
        .rol-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .rol-option {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .rol-option:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .rol-option input[type="radio"] {
            display: none;
        }

        .rol-option input[type="radio"]:checked + .rol-content {
            color: #4CAF50;
        }

        .rol-option input[type="radio"]:checked ~ {
            border-color: #4CAF50;
            background: #f1f8f4;
        }

        .rol-option.selected {
            border-color: #4CAF50;
            background: #f1f8f4;
        }

        .rol-content h3 {
            margin: 0.5rem 0;
            font-size: 1.25rem;
        }

        .rol-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .rol-content p {
            font-size: 0.875rem;
            color: #666;
            margin: 0.5rem 0 0 0;
        }

        @media (max-width: 600px) {
            .rol-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="login-container">
    <div class="login-form">
        <h1>Crear Cuenta</h1>
        <p style="text-align: center; color: #666; margin-bottom: 1.5rem;">
            Únete a nuestra comunidad contra el desperdicio de alimentos
        </p>

        <form id="registerForm">
            <!-- Selector de Rol -->
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                    ¿Cómo deseas usar la plataforma?
                </label>
                <div class="rol-selector">
                    <label class="rol-option selected" for="rol-usuario">
                        <input type="radio" name="rol" id="rol-usuario" value="usuario" checked>
                        <div class="rol-content">
                            <div class="rol-icon">🛒</div>
                            <h3>Usuario</h3>
                            <p>Compra comida a precios reducidos</p>
                        </div>
                    </label>

                    <label class="rol-option" for="rol-vendedor">
                        <input type="radio" name="rol" id="rol-vendedor" value="vendedor">
                        <div class="rol-content">
                            <div class="rol-icon">🏪</div>
                            <h3>Vendedor</h3>
                            <p>Publica y vende productos</p>
                        </div>
                    </label>
                </div>
            </div>

            <label for="nombre_completo">Nombre Completo:</label>
            <input type="text" id="nombre_completo" name="nombre_completo" required>

            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>

            <label for="username">Nombre de Usuario:</label>
            <input type="text" id="username" name="username" required 
                   pattern="[a-zA-Z0-9._-]{3,50}" 
                   title="3-50 caracteres: letras, números, punto, guion">

            <label for="password">Contraseña:</label>
            <input type="password" id="password" name="password" required minlength="6">

            <label for="password_confirm">Confirmar Contraseña:</label>
            <input type="password" id="password_confirm" name="password_confirm" required>

            <button type="submit">Registrarse</button>
            
            <div id="error-message" class="alert" style="display: none;"></div>
        </form>
        
        <p style="text-align: center; margin-top: 20px;">
            ¿Ya tienes cuenta? <a href="login.html">Inicia sesión aquí</a>
        </p>
        
        <p style="text-align: center; margin-top: 10px;">
            <a href="index.html">Volver al inicio</a>
        </p>
    </div>

    <script>
        const API_BASE = location.hostname.includes('netlify.app') || location.hostname.includes('github.io')
            ? 'https://proyecto-comida-backend.onrender.com'
            : 'http://localhost:3000';

        // Manejar selección de rol visual
        document.querySelectorAll('.rol-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.rol-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });

        // Manejar envío del formulario
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nombre_completo = document.getElementById('nombre_completo').value.trim();
            const email = document.getElementById('email').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const password_confirm = document.getElementById('password_confirm').value;
            const rol = document.querySelector('input[name="rol"]:checked').value;
            const errorMessage = document.getElementById('error-message');

            // Limpiar mensajes previos
            errorMessage.style.display = 'none';

            // Validaciones básicas
            if (!nombre_completo || !email || !username || !password || !password_confirm) {
                showError('Por favor, completa todos los campos.');
                return;
            }

            if (password !== password_confirm) {
                showError('Las contraseñas no coinciden.');
                return;
            }

            if (password.length < 6) {
                showError('La contraseña debe tener al menos 6 caracteres.');
                return;
            }

            if (username.length < 3 || username.length > 50) {
                showError('El nombre de usuario debe tener entre 3 y 50 caracteres.');
                return;
            }

            if (!/^[a-zA-Z0-9._-]+$/.test(username)) {
                showError('El nombre de usuario solo puede contener letras, números, punto, guion y guion bajo.');
                return;
            }

            try {
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Registrando...';
                submitBtn.disabled = true;

                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        password,
                        email,
                        nombre_completo,
                        rol
                    }),
                });

                const result = await response.json().catch(() => ({}));

                if (response.ok) {
                    showSuccess('¡Registro exitoso! Redirigiendo al login...');
                    
                    // Redirigir al login después de 2 segundos
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showError(result.mensaje || 'Error al registrar usuario');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }

            } catch (error) {
                console.error('Error de conexión:', error);
                showError('Error de conexión. Verifica tu internet e intenta de nuevo.');
                
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Registrarse';
                submitBtn.disabled = false;
            }
        });

        function showError(message) {
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorMessage.className = 'alert';
            errorMessage.style.display = 'block';
        }

        function showSuccess(message) {
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorMessage.className = 'alert success';
            errorMessage.style.display = 'block';
        }

        // Enfocar el primer campo al cargar
        window.addEventListener('load', () => {
            document.getElementById('nombre_completo').focus();
        });
    </script>
</body>
</html>