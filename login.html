<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi√≥n - Comida Sobrante</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body class="login-container">
    <div class="login-form">
        <h1>Iniciar Sesi√≥n</h1>
        <p style="text-align: center; color: #666; margin-bottom: 1.5rem;">
            Accede a tu cuenta
        </p>

        <form id="loginForm">
            <label for="username">Nombre de usuario:</label>
            <input type="text" id="username" name="username" required autocomplete="username">
            
            <label for="password">Contrase√±a:</label>
            <input type="password" id="password" name="password" required autocomplete="current-password">
            
            <button type="submit" id="submitBtn">Iniciar sesi√≥n</button>
            
            <div id="errorMessage" class="alert" style="display: none;"></div>
        </form>
        
        <p style="text-align: center; margin-top: 20px;">
            ¬øNo tienes cuenta? <a href="register.html">Reg√≠strate aqu√≠</a>
        </p>
        
        <p style="text-align: center; margin-top: 10px;">
            <a href="index.html">Volver al inicio</a>
        </p>
    </div>

    <script>
        const API_BASE = location.hostname.includes('netlify.app') || location.hostname.includes('github.io')
            ? 'https://proyecto-comida-backend.onrender.com'
            : 'http://localhost:3000';

        console.log('üîó API Base URL:', API_BASE);

        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const userRol = localStorage.getItem('userRol');
        
        if (isLoggedIn === 'true' && userRol) {
            console.log('‚úÖ Usuario ya logueado, redirigiendo...');
            if (userRol === 'vendedor') {
                window.location.href = 'dashboard-vendedor.html';
            } else if (userRol === 'admin') {
                window.location.href = 'dashboard.html';
            } else {
                window.location.href = 'dashboard-usuario.html';
            }
        }

        const loginForm = document.getElementById('loginForm');
        const submitBtn = document.getElementById('submitBtn');
        const errorMessage = document.getElementById('errorMessage');
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            console.log('üìù Intentando login con:', username);

            errorMessage.style.display = 'none';

            if (!username || !password) {
                showError('Por favor, completa todos los campos.');
                return;
            }

            try {
                submitBtn.textContent = 'Iniciando sesi√≥n...';
                submitBtn.disabled = true;

                console.log('üåê Enviando petici√≥n a:', `${API_BASE}/auth/login`);

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                console.log('üì° Respuesta status:', response.status);

                let result;
                try {
                    result = await response.json();
                    console.log('üì¶ Respuesta del servidor:', result);
                } catch (jsonError) {
                    console.error('‚ùå Error al parsear JSON:', jsonError);
                    result = {};
                }

                if (response.ok && result.usuario) {
                    console.log('‚úÖ Login exitoso');
                    showSuccess('Login exitoso. Redirigiendo...');
                    
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userId', result.usuario.id);
                    localStorage.setItem('username', result.usuario.username);
                    localStorage.setItem('userEmail', result.usuario.email || '');
                    localStorage.setItem('userNombre', result.usuario.nombre_completo || '');
                    localStorage.setItem('userRol', result.usuario.rol);
                    localStorage.setItem('loginTime', Date.now().toString());
                    
                    console.log('üíæ Datos guardados en localStorage');
                    console.log('üë§ Rol:', result.usuario.rol);
                    
                    setTimeout(() => {
                        if (result.usuario.rol === 'vendedor') {
                            console.log('‚Ü™ Redirigiendo a dashboard vendedor');
                            window.location.href = 'dashboard-vendedor.html';
                        } else if (result.usuario.rol === 'admin') {
                            console.log('‚Ü™ Redirigiendo a dashboard admin');
                            window.location.href = 'dashboard.html';
                        } else {
                            console.log('‚Ü™ Redirigiendo a dashboard usuario');
                            window.location.href = 'dashboard-usuario.html';
                        }
                    }, 1200);
                } else {
                    console.error('‚ùå Login fallido:', result.mensaje);
                    showError(result.mensaje || 'Usuario o contrase√±a inv√°lidos');
                    submitBtn.textContent = 'Iniciar sesi√≥n';
                    submitBtn.disabled = false;
                }

            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showError('Error de conexi√≥n con el servidor. Verifica tu internet.');
                submitBtn.textContent = 'Iniciar sesi√≥n';
                submitBtn.disabled = false;
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.className = 'alert';
            errorMessage.style.display = 'block';
        }

        function showSuccess(message) {
            errorMessage.textContent = message;
            errorMessage.className = 'alert success';
            errorMessage.style.display = 'block';
        }

        window.addEventListener('load', () => {
            document.getElementById('username').focus();
        });
    </script>
</body>
</html>