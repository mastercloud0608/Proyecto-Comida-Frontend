<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comida Sobrante en L√≠nea</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <header>
        <div class="logo">
            <h1>Comida Sobrante</h1>
            <p>Reduciendo el desperdicio, alimentando el futuro</p>
        </div>
        <nav>
            <ul>
                <li><a href="index.html" aria-label="Ir a inicio">Inicio</a></li>
                <li><a href="comida.html" aria-label="Ver comidas disponibles">Comidas</a></li>
                <li><a href="pedidos.html" aria-label="Ver pedidos">Pedidos</a></li>
                <li><a href="#como-funciona" aria-label="C√≥mo funciona">C√≥mo Funciona</a></li>
                <li><a href="#contacto" aria-label="Contacto">Cont√°ctanos</a></li>
                <li><a href="#" id="login-link" aria-label="Iniciar sesi√≥n">Iniciar Sesi√≥n</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="hero">
            <h2>¬°Disfruta comida deliciosa y econ√≥mica!</h2>
            <p>Reduce el desperdicio y ahorra comprando comida en buen estado a precios m√°s bajos.</p>
            <a href="comida.html" class="btn" aria-label="Ver comidas disponibles">Ver Comidas Disponibles</a>
        </section>

        <section class="benefits">
            <h2>¬øPor qu√© elegirnos?</h2>
            <div class="benefits-container">
                <div class="benefit">
                    <h3>Ahorra dinero</h3>
                    <p>Comida deliciosa a precios accesibles, perfecta para tu bolsillo.</p>
                </div>
                <div class="benefit">
                    <h3>Ayuda al medio ambiente</h3>
                    <p>Contribuye a reducir el desperdicio de alimentos y cuida el planeta.</p>
                </div>
                <div class="benefit">
                    <h3>Apoya la econom√≠a circular</h3>
                    <p>Compra alimentos de calidad, ayudando a los negocios locales a reducir p√©rdidas.</p>
                </div>
            </div>
        </section>

        <!-- Nueva secci√≥n: C√≥mo Funciona -->
        <section id="como-funciona" class="como-funciona">
            <h2>¬øC√≥mo Funciona?</h2>
            <div class="proceso-container">
                <div class="paso">
                    <div class="paso-numero">1</div>
                    <h3>Explora las Comidas</h3>
                    <p>Navega por nuestra selecci√≥n de comidas frescas disponibles a precios reducidos.</p>
                </div>
                <div class="paso">
                    <div class="paso-numero">2</div>
                    <h3>Haz tu Pedido</h3>
                    <p>Selecciona la comida que deseas y completa tu informaci√≥n para hacer el pedido.</p>
                </div>
                <div class="paso">
                    <div class="paso-numero">3</div>
                    <h3>Recoge tu Comida</h3>
                    <p>Dir√≠gete al lugar indicado en el horario acordado para recoger tu pedido.</p>
                </div>
                <div class="paso">
                    <div class="paso-numero">4</div>
                    <h3>¬°Disfruta!</h3>
                    <p>Disfruta de tu comida deliciosa mientras ayudas al medio ambiente.</p>
                </div>
            </div>
        </section>

        <!-- Nueva secci√≥n: Estad√≠sticas de Impacto -->
        <section class="impacto-section">
            <h2>Nuestro Impacto</h2>
            <div class="impacto-stats" id="impactoStats">
                <div class="stat-card">
                    <div class="stat-icon">üçΩÔ∏è</div>
                    <div class="stat-number" id="comidasSalvadas">0</div>
                    <div class="stat-label">Comidas Salvadas del Desperdicio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-number" id="ahorroClientes">Bs 0</div>
                    <div class="stat-label">Ahorro Total de Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üåç</div>
                    <div class="stat-number" id="co2Reducido">0 kg</div>
                    <div class="stat-label">CO‚ÇÇ Evitado</div>
                </div>
            </div>
        </section>

        <!-- Secci√≥n de Contacto -->
        <section id="contacto" class="contacto-section">
            <h2>Cont√°ctanos</h2>
            <div class="contacto-container">
                <div class="contacto-info">
                    <h3>¬øTienes preguntas?</h3>
                    <p>Estamos aqu√≠ para ayudarte. Cont√°ctanos por cualquier consulta sobre nuestro servicio.</p>
                    <div class="contacto-items">
                        <div class="contacto-item">
                            <strong>üìß Email:</strong> info@comidasobrante.com
                        </div>
                        <div class="contacto-item">
                            <strong>üì± WhatsApp:</strong> +591 7000-0000
                        </div>
                        <div class="contacto-item">
                            <strong>üìç Ubicaci√≥n:</strong> Santa Cruz de la Sierra, Bolivia
                        </div>
                    </div>
                </div>
                <div class="contacto-form">
                    <h3>Env√≠anos un mensaje</h3>
                    <form id="contacto-form">
                        <div class="form-group">
                            <input type="text" id="contacto-nombre" placeholder="Tu nombre" required>
                        </div>
                        <div class="form-group">
                            <input type="email" id="contacto-email" placeholder="Tu email" required>
                        </div>
                        <div class="form-group">
                            <textarea id="contacto-mensaje" placeholder="Tu mensaje" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="btn">Enviar Mensaje</button>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <!-- Login Modal -->
    <div id="login-modal" class="modal" role="dialog" aria-labelledby="login-title" aria-hidden="true">
        <div class="modal-content">
            <span class="close" aria-label="Cerrar modal">&times;</span>
            <h2 id="login-title">Iniciar Sesi√≥n</h2>
            <form id="login-form">
                <label for="username">Nombre de Usuario</label>
                <input type="text" id="username" name="username" required aria-describedby="username-error">

                <label for="password">Contrase√±a</label>
                <input type="password" id="password" name="password" required aria-describedby="password-error">

                <button type="submit" class="btn">Iniciar sesi√≥n</button>
                
                <div id="login-error" class="alert" style="display: none;"></div>
            </form>
            <p>¬øNo tienes cuenta? <a href="#" id="register-link">Reg√≠strate aqu√≠</a></p>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal" role="dialog" aria-labelledby="register-title" aria-hidden="true">
        <div class="modal-content">
            <span class="close" aria-label="Cerrar modal">&times;</span>
            <h2 id="register-title">Registrar Nueva Cuenta</h2>
            <form id="register-form">
                <label for="new-username">Nombre de Usuario</label>
                <input type="text" id="new-username" name="username" required minlength="3">

                <label for="new-password">Contrase√±a</label>
                <input type="password" id="new-password" name="password" required minlength="6">

                <label for="confirm-password">Confirmar Contrase√±a</label>
                <input type="password" id="confirm-password" name="confirmPassword" required>

                <button type="submit" class="btn">Registrar</button>
                
                <div id="register-error" class="alert" style="display: none;"></div>
            </form>
            <p>¬øYa tienes cuenta? <a href="#" id="login-from-register">Inicia sesi√≥n aqu√≠</a></p>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Comida Sobrante. Proyecto de Responsabilidad Social - Unidad Educativa Padre Jaime Gagnon 1</p>
    </footer>

    <script>
        // === BASE API (prod/local) ===
        const API_BASE = location.hostname.endsWith('netlify.app')
          ? 'https://proyecto-comida-backend.onrender.com' // <-- tu backend p√∫blico
          : 'http://localhost:3000';

        // Modal functionality
        const loginModal = document.getElementById('login-modal');
        const registerModal = document.getElementById('register-modal');
        const loginLink = document.getElementById('login-link');
        const registerLink = document.getElementById('register-link');
        const loginFromRegister = document.getElementById('login-from-register');
        const closeBtns = document.querySelectorAll('.close');

        // Cargar estad√≠sticas de impacto al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarEstadisticasImpacto();
        });

        // Verificar si ya est√° logueado al cargar la p√°gina
        window.addEventListener('load', () => {
            if (localStorage.getItem('isLoggedIn') === 'true') {
                loginLink.textContent = 'Dashboard';
                loginLink.onclick = (e) => {
                    e.preventDefault();
                    window.location.href = 'pedidos.html';
                };
            }
        });

        // Cargar estad√≠sticas de impacto (AJUSTADO a API_BASE)
        async function cargarEstadisticasImpacto() {
            try {
                const response = await fetch(`${API_BASE}/api/pedidos/estadisticas/resumen`);
                if (response.ok) {
                    const stats = await response.json();
                    
                    const totalPedidos = stats.total_pedidos ?? 0;
                    const totalVentas = Array.isArray(stats.por_estado)
                      ? stats.por_estado.reduce((sum, e) => sum + parseFloat(e.total_ventas || 0), 0)
                      : parseFloat(stats.estadisticas_hoy?.ventas_hoy || 0);

                    // Estimaciones de impacto ambiental
                    const co2PorComida = 2.5; // kg CO2 promedio por comida desperdiciada
                    const co2Evitado = totalPedidos * co2PorComida;
                    
                    // Actualizar n√∫meros con animaci√≥n
                    animateNumber('comidasSalvadas', totalPedidos);
                    animateNumber('ahorroClientes', totalVentas, 'Bs ');
                    animateNumber('co2Reducido', Math.round(co2Evitado), '', ' kg');
                } else {
                    throw new Error('No OK');
                }
            } catch (error) {
                console.log('No se pudieron cargar las estad√≠sticas de impacto');
                // Fallbacks visibles
                animateNumber('comidasSalvadas', 156);
                animateNumber('ahorroClientes', 2340.50, 'Bs ');
                animateNumber('co2Reducido', 390, '', ' kg');
            }
        }

        // Funci√≥n para animar n√∫meros
        function animateNumber(elementId, finalValue, prefix = '', suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const startValue = 0;
            const duration = 2000; // 2 segundos
            const steps = Math.max(Math.floor(duration / 16), 1);
            const increment = (finalValue - startValue) / steps;
            let currentValue = startValue;
            let step = 0;
            
            const timer = setInterval(() => {
                step++;
                currentValue += increment;
                if (step >= steps) {
                    currentValue = finalValue;
                    clearInterval(timer);
                }
                
                const displayValue = typeof finalValue === 'number' && finalValue % 1 !== 0 
                    ? currentValue.toFixed(2) 
                    : Math.floor(currentValue);
                
                element.textContent = prefix + displayValue + suffix;
            }, 16);
        }

        // Open login modal
        loginLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (localStorage.getItem('isLoggedIn') === 'true') {
                window.location.href = 'pedidos.html';
                return;
            }
            loginModal.style.display = 'block';
            loginModal.setAttribute('aria-hidden', 'false');
        });

        // Switch to register modal
        registerLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.style.display = 'none';
            registerModal.style.display = 'block';
            loginModal.setAttribute('aria-hidden', 'true');
            registerModal.setAttribute('aria-hidden', 'false');
        });

        // Switch back to login modal
        loginFromRegister.addEventListener('click', (e) => {
            e.preventDefault();
            registerModal.style.display = 'none';
            loginModal.style.display = 'block';
            registerModal.setAttribute('aria-hidden', 'true');
            loginModal.setAttribute('aria-hidden', 'false');
        });

        // Close modals
        closeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                loginModal.style.display = 'none';
                registerModal.style.display = 'none';
                loginModal.setAttribute('aria-hidden', 'true');
                registerModal.setAttribute('aria-hidden', 'true');
            });
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === loginModal || e.target === registerModal) {
                loginModal.style.display = 'none';
                registerModal.style.display = 'none';
                loginModal.setAttribute('aria-hidden', 'true');
                registerModal.setAttribute('aria-hidden', 'true');
            }
        });

        // Handle login form submission (AJUSTADO a /auth/login)
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.style.display = 'none';

            if (!username || !password) {
                showLoginError('Por favor, completa todos los campos.');
                return;
            }

            try {
                const submitBtn = document.querySelector('#login-form button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Iniciando sesi√≥n...';
                submitBtn.disabled = true;

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });

                const result = await response.json().catch(() => ({}));

                if (response.ok) {
                    localStorage.setItem('isLoggedIn', 'true');
                    if (result.usuario) {
                        localStorage.setItem('userId', result.usuario.id);
                        localStorage.setItem('username', result.usuario.username);
                    }
                    localStorage.setItem('loginTime', String(Date.now()));
                    
                    showLoginSuccess('Login exitoso. Redirigiendo...');
                    setTimeout(() => { window.location.href = 'pedidos.html'; }, 1200);
                } else {
                    showLoginError(result.mensaje || 'Error al iniciar sesi√≥n');
                }

                submitBtn.textContent = originalText;
                submitBtn.disabled = false;

            } catch (error) {
                console.error('Error de conexi√≥n:', error);
                showLoginError('Error de conexi√≥n. Intenta de nuevo.');
                const submitBtn = document.querySelector('#login-form button[type="submit"]');
                submitBtn.textContent = 'Iniciar sesi√≥n';
                submitBtn.disabled = false;
            }
        });

        // Handle register form submission (AJUSTADO a /auth/register)
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('register-error');
            errorDiv.style.display = 'none';

            if (!username || !password || !confirmPassword) {
                showRegisterError('Por favor, completa todos los campos.');
                return;
            }
            if (username.length < 3) {
                showRegisterError('El nombre de usuario debe tener al menos 3 caracteres.');
                return;
            }
            if (password.length < 6) {
                showRegisterError('La contrase√±a debe tener al menos 6 caracteres.');
                return;
            }
            if (password !== confirmPassword) {
                showRegisterError('Las contrase√±as no coinciden.');
                return;
            }

            try {
                const submitBtn = document.querySelector('#register-form button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Registrando...';
                submitBtn.disabled = true;

                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });

                const result = await response.json().catch(() => ({}));

                if (response.ok) {
                    showRegisterSuccess('Usuario registrado con √©xito. Cambiando al login...');
                    document.getElementById('register-form').reset();
                    setTimeout(() => {
                        registerModal.style.display = 'none';
                        loginModal.style.display = 'block';
                        registerModal.setAttribute('aria-hidden', 'true');
                        loginModal.setAttribute('aria-hidden', 'false');
                    }, 1500);
                } else {
                    showRegisterError(result.mensaje || 'Error al registrar usuario');
                }

                submitBtn.textContent = 'Registrar';
                submitBtn.disabled = false;

            } catch (error) {
                console.error('Error de conexi√≥n:', error);
                showRegisterError('Error de conexi√≥n. Intenta de nuevo.');
                const submitBtn = document.querySelector('#register-form button[type="submit"]');
                submitBtn.textContent = 'Registrar';
                submitBtn.disabled = false;
            }
        });

        // Handle contact form submission
        document.getElementById('contacto-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const nombre = document.getElementById('contacto-nombre').value;
            alert(`¬°Gracias ${nombre}! Tu mensaje ha sido enviado. Te contactaremos pronto.`);
            this.reset();
        });

        // Helpers de UI
        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.className = 'alert';
            errorDiv.style.display = 'block';
        }
        function showLoginSuccess(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.className = 'alert success';
            errorDiv.style.display = 'block';
        }
        function showRegisterError(message) {
            const errorDiv = document.getElementById('register-error');
            errorDiv.textContent = message;
            errorDiv.className = 'alert';
            errorDiv.style.display = 'block';
        }
        function showRegisterSuccess(message) {
            const errorDiv = document.getElementById('register-error');
            errorDiv.textContent = message;
            errorDiv.className = 'alert success';
            errorDiv.style.display = 'block';
        }

        // Validaci√≥n en tiempo real de confirmaci√≥n de contrase√±a
        document.getElementById('confirm-password').addEventListener('input', function() {
            const password = document.getElementById('new-password').value;
            const confirmPassword = this.value;
            if (confirmPassword && password !== confirmPassword) {
                this.setCustomValidity('Las contrase√±as no coinciden');
                this.style.borderColor = '#d32f2f';
            } else {
                this.setCustomValidity('');
                this.style.borderColor = '#ccc';
            }
        });

        // Smooth scrolling
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
    </script>
</body>
</html>
