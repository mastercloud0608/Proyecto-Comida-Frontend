<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Comida Sobrante</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <header>
        <div class="logo">
            <h1>Dashboard - Comida Sobrante</h1>
            <p>Panel de administración - <span id="welcome-user">Bienvenido</span></p>
        </div>
        <nav>
            <ul>
                <li><a href="index.html" aria-label="Ir a inicio">Inicio</a></li>
                <li><a href="#statistics" aria-label="Ver ventas">Ventas</a></li>
                <li><a href="#statistics" aria-label="Ver impacto">Impacto</a></li>
                <li><a href="pedidos.html" aria-label="Gestionar pedidos">Pedidos</a></li>
                <li><a href="#" id="logout-btn" aria-label="Cerrar sesión">Cerrar sesión</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- Hero Section -->
        <section class="hero">
            <h2>Bienvenido al Dashboard</h2>
            <p>Monitorea el impacto de tu plataforma de comida sobrante y observa los resultados en tiempo real.</p>
            <a href="#statistics" class="btn" aria-label="Ver estadísticas detalladas">Ver Datos</a>
        </section>

        <!-- Statistics Section -->
        <section id="statistics" class="benefits">
            <h2>Estadísticas de Impacto</h2>
            <div class="benefits-container">
                <div class="benefit">
                    <h3 id="waste-reduced">Cargando...</h3>
                    <p>Desperdicio de comida reducido (estimado)</p>
                </div>
                <div class="benefit">
                    <h3 id="money-saved">Cargando...</h3>
                    <p>Ahorros generados para los consumidores</p>
                </div>
                <div class="benefit">
                    <h3 id="active-users">Cargando...</h3>
                    <p>Usuarios activos (emails únicos)</p>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="benefits">
            <h2>Características de la Plataforma</h2>
            <div class="benefits-container">
                <div class="benefit">
                    <h3>Reducción de Desperdicio</h3>
                    <p>Ayuda a disminuir el desperdicio alimentario con cada venta realizada en la plataforma.</p>
                </div>
                <div class="benefit">
                    <h3>Ahorro Económico</h3>
                    <p>Los consumidores pueden acceder a alimentos de calidad a precios significativamente reducidos.</p>
                </div>
                <div class="benefit">
                    <h3>Impacto Ambiental</h3>
                    <p>Contribuye a la reducción de la huella de carbono generada por el desperdicio de alimentos.</p>
                </div>
            </div>
        </section>

        <!-- Management Section -->
        <section class="benefits">
            <h2>Gestión de la Plataforma</h2>
            <div class="benefits-container">
                <div class="benefit">
                    <h3>Gestión de Productos</h3>
                    <p>Administra el inventario de productos disponibles y sus precios.</p>
                    <a href="comida.html" class="btn" style="margin-top: 15px;">Gestionar Productos</a>
                </div>
                <div class="benefit">
                    <h3>Reportes y Analytics</h3>
                    <p>Accede a reportes detallados sobre ventas, usuarios e impacto ambiental.</p>
                    <a href="#statistics" class="btn" style="margin-top: 15px;">Ver Reportes</a>
                </div>
                <div class="benefit">
                    <h3>Configuración</h3>
                    <p>Configura parámetros de la plataforma y preferencias del sistema.</p>
                    <a href="index.html#contacto" class="btn" style="margin-top: 15px;">Configurar</a>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer Section -->
    <footer>
        <p>&copy; 2025 Proyecto Comida Sobrante. Todos los derechos reservados.</p>
    </footer>

    <script>
        // === BASE API (prod/local) ===
        const API_BASE = location.hostname.endsWith('netlify.app')
          ? 'https://proyecto-comida-backend.onrender.com' // <-- tu backend público
          : 'http://localhost:3000';

        // Verificar autenticación al cargar la página
        window.addEventListener('load', () => {
            checkAuthentication();
            displayWelcomeMessage();
            loadDashboardData();
        });

        // Prevenir acceso directo sin autenticación
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.replace('index.html'); // allí está tu login modal
        }

        // Función para verificar autenticación
        function checkAuthentication() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const loginTime = localStorage.getItem('loginTime');
            
            if (!isLoggedIn || isLoggedIn !== 'true') {
                alert('Debes iniciar sesión para acceder al dashboard.');
                window.location.replace('index.html');
                return;
            }
            // Expirar a las 24h
            if (loginTime) {
                const currentTime = Date.now();
                const sessionDuration = 24 * 60 * 60 * 1000; // 24h
                if (currentTime - parseInt(loginTime) > sessionDuration) {
                    alert('Tu sesión ha expirado. Por favor, inicia sesión nuevamente.');
                    logout();
                }
            }
        }

        // Mostrar mensaje de bienvenida personalizado
        function displayWelcomeMessage() {
            const username = localStorage.getItem('username');
            const welcomeElement = document.getElementById('welcome-user');
            if (username && welcomeElement) {
                welcomeElement.textContent = `Bienvenido, ${username}`;
            }
        }

        // Helper para normalizar {items, meta} o []
        const asArray = (data) => Array.isArray(data) ? data : (data?.items || []);

        // Cargar datos del dashboard (desde tu API)
        async function loadDashboardData() {
            try {
                // 1) Resumen de estadísticas de pedidos
                const statsResp = await fetch(`${API_BASE}/api/pedidos/estadisticas/resumen`);
                if (!statsResp.ok) throw new Error('Stats no disponibles');
                const stats = await statsResp.json();

                // Total de pedidos
                const totalPedidos = stats.total_pedidos ?? 0;

                // Ventas totales (preferimos sumar por_estado si existe)
                const totalVentas = Array.isArray(stats.por_estado)
                    ? stats.por_estado.reduce((sum, e) => sum + parseFloat(e.total_ventas || 0), 0)
                    : parseFloat(stats.estadisticas_hoy?.ventas_hoy || 0);

                // Desperdicio evitado (estimación 2.5 kg por pedido)
                const co2KgPorComida = 2.5;
                const wasteReducedKg = Math.round(totalPedidos * co2KgPorComida);

                // 2) Usuarios activos (emails únicos en últimos N pedidos)
                let activeUsers = 0;
                try {
                    const pedidosResp = await fetch(`${API_BASE}/api/pedidos?limit=200`);
                    if (pedidosResp.ok) {
                        const data = await pedidosResp.json();
                        const pedidos = asArray(data);
                        const setEmails = new Set(
                            pedidos
                              .map(p => (p.email_cliente || '').trim().toLowerCase())
                              .filter(Boolean)
                        );
                        activeUsers = setEmails.size;
                    }
                } catch { /* silencioso */ }

                updateStatistics({
                    wasteReduced: wasteReducedKg,
                    moneySaved: totalVentas,
                    activeUsers
                });

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Fallback por si la API no responde
                updateStatistics({
                    wasteReduced: 1250,
                    moneySaved: 3420,
                    activeUsers: 486
                });
            }
        }

        // Actualizar estadísticas en el dashboard
        function updateStatistics(data) {
            const wasteElement = document.getElementById('waste-reduced');
            const moneyElement = document.getElementById('money-saved');
            const usersElement = document.getElementById('active-users');

            if (wasteElement) {
                wasteElement.textContent = `${Number(data.wasteReduced || 0).toLocaleString()} kg`;
            }
            if (moneyElement) {
                const monto = Number(data.moneySaved || 0);
                moneyElement.textContent = `Bs ${monto.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
            if (usersElement) {
                usersElement.textContent = Number(data.activeUsers || 0).toLocaleString();
            }
        }

        // Manejar cierre de sesión
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                logout();
            }
        });

        // Función de logout
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            localStorage.removeItem('loginTime');
            sessionStorage.clear();
            alert('Sesión cerrada exitosamente.');
            window.location.replace('index.html');
        }

        // Actualizar estadísticas cada 30 segundos
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>
