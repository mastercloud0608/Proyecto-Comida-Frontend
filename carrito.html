<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - Comida Sobrante</title>
    <link rel="stylesheet" href="assets/styles.css">
    <style>
        .carrito-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }
        @media (max-width: 768px) {
            .carrito-container { grid-template-columns: 1fr; }
        }
        .carrito-items {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .carrito-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        .carrito-item:last-child { border-bottom: none; }
        .item-info { flex: 1; }
        .item-info h4 { margin: 0 0 0.25rem 0; color: #333; }
        .item-empresa {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .item-categoria {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .item-descuento-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #ff5722;
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        .item-controles {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        .cantidad-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.25rem;
        }
        .cantidad-control button {
            width: 30px;
            height: 30px;
            border: none;
            background: #f5f5f5;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1.125rem;
        }
        .cantidad-control button:hover { background: #e0e0e0; }
        .cantidad-control span { min-width: 30px; text-align: center; }
        .item-precio { text-align: right; min-width: 120px; }
        .precio-original {
            font-size: 0.875rem;
            color: #999;
            text-decoration: line-through;
            margin-bottom: 0.25rem;
        }
        .precio-con-descuento {
            font-size: 1rem;
            font-weight: bold;
            color: #4CAF50;
        }
        .precio-total {
            font-size: 1.25rem;
            font-weight: bold;
            color: #4CAF50;
            margin-top: 0.25rem;
        }
        .btn-eliminar {
            background: #f44336;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .btn-eliminar:hover { background: #d32f2f; }
        .carrito-sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        .resumen-pedido {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .resumen-pedido h3 {
            margin: 0 0 1rem 0;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }
        .resumen-linea {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        .resumen-ahorro { color: #4CAF50; font-weight: bold; }
        .resumen-total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #eee;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .formulario-cliente {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #eee;
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        .payment-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .payment-option:hover {
            border-color: #4CAF50;
            background: #f9f9f9;
        }
        .payment-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .payment-option input[type="radio"]:checked ~ span {
            font-weight: bold;
            color: #4CAF50;
        }
        .btn-proceder-pago {
            width: 100%;
            padding: 1rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.125rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 1rem;
        }
        .btn-proceder-pago:hover:not(:disabled) { background: #45a049; }
        .btn-proceder-pago:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .carrito-vacio {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        .carrito-vacio i {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }
        .btn-continuar-comprando {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
        }
        .modal-pago {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .modal-pago-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            max-width: 500px;
            border-radius: 8px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .pago-mensaje {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            text-align: center;
        }
        .pago-mensaje.exito {
            background: #d4edda;
            color: #155724;
        }
        .pago-mensaje.error {
            background: #f8d7da;
            color: #721c24;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideInAlert 0.3s ease;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
        }
        .alert.error {
            background: #f8d7da;
            color: #721c24;
        }
        @keyframes slideInAlert {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .qr-code-container {
            text-align: center;
            padding: 2rem;
        }
        .qr-code-container img {
            max-width: 300px;
            margin: 1rem auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            background: white;
        }
        .payment-instructions {
            background: #fff3cd;
            border-left: 4px solid #ffa726;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .payment-instructions h4 {
            margin: 0 0 0.5rem 0;
            color: #f57c00;
        }
        .btn-pagar {
            width: 100%;
            padding: 1rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.125rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-pagar:hover:not(:disabled) { background: #45a049; }
        .btn-pagar:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <h1>Comida Sobrante</h1>
            <p>Reduciendo el desperdicio, alimentando el futuro</p>
        </div>
        <nav>
            <ul>
                <li><a href="index.html">Inicio</a></li>
                <li><a href="comida.html">Comidas</a></li>
                <li><a href="pedidos.html">Pedidos</a></li>
                <li><a href="carrito.html">🛒 Carrito (<span id="cartCount">0</span>)</a></li>
            </ul>
        </nav>
    </header>

    <section class="hero">
        <h2>Mi Carrito de Compras</h2>
        <p>Revisa tu pedido y procede al pago</p>
    </section>

    <div class="carrito-container">
        <div class="carrito-items">
            <h3>Productos en tu carrito</h3>
            <div id="carritoItemsContainer">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="carrito-sidebar">
            <div class="resumen-pedido">
                <h3>Resumen del Pedido</h3>
                <div class="resumen-linea">
                    <span>Subtotal:</span>
                    <span id="subtotal">Bs 0.00</span>
                </div>
                <div class="resumen-linea resumen-ahorro">
                    <span>🎉 Ahorras:</span>
                    <span id="ahorro">Bs 0.00</span>
                </div>
                <div class="resumen-linea">
                    <span>Impuestos:</span>
                    <span id="impuestos">Bs 0.00</span>
                </div>
                <div class="resumen-linea resumen-total">
                    <span>Total:</span>
                    <span id="total">Bs 0.00</span>
                </div>

                <div class="formulario-cliente">
                    <h4>Información de Contacto</h4>
                    <form id="formCliente">
                        <div class="form-group">
                            <label for="nombreCliente">Nombre Completo *</label>
                            <input type="text" id="nombreCliente" required>
                        </div>
                        <div class="form-group">
                            <label for="emailCliente">Email *</label>
                            <input type="email" id="emailCliente" required>
                        </div>
                        <div class="form-group">
                            <label for="telefonoCliente">Teléfono</label>
                            <input type="tel" id="telefonoCliente">
                        </div>
                        <div class="form-group">
                            <label for="direccion">Dirección de Entrega</label>
                            <textarea id="direccion" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Método de Pago *</label>
                            <div class="payment-methods">
                                <label class="payment-option">
                                    <input type="radio" name="metodo_pago" value="tarjeta" checked>
                                    <span>💳 Tarjeta de Crédito/Débito</span>
                                </label>
                                <label class="payment-option">
                                    <input type="radio" name="metodo_pago" value="efectivo">
                                    <span>💵 Efectivo</span>
                                </label>
                                <label class="payment-option">
                                    <input type="radio" name="metodo_pago" value="qr">
                                    <span>📱 Pago QR</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>

                <button class="btn-proceder-pago" id="btnProcederPago" disabled>
                    Proceder al Pago
                </button>
            </div>
        </div>
    </div>

    <div id="modalPago" class="modal-pago">
        <div class="modal-pago-content">
            <h3 id="modalPagoTitulo">Procesando Pago</h3>
            <div id="pagoMensaje"></div>
            
            <div id="modalPagoContenido">
                <div id="tarjeta-content" style="display:none;">
                    <div class="payment-instructions">
                        <h4>✨ Pago Automático</h4>
                        <p><strong>Monto a pagar:</strong> <span id="tarjeta-monto">Bs 0.00</span></p>
                        <p>El sistema confirmará tu pedido instantáneamente.</p>
                    </div>
                    <button id="btnConfirmarTarjeta" class="btn-pagar">Confirmar Pago</button>
                </div>
                
                <div id="efectivo-content" style="display:none;">
                    <div class="payment-instructions">
                        <h4>✨ Pago en Efectivo</h4>
                        <p><strong>Monto a pagar:</strong> <span id="efectivo-monto">Bs 0.00</span></p>
                        <p>Pagarás en efectivo al recibir tu pedido.</p>
                    </div>
                    <button id="btnConfirmarEfectivo" class="btn-pagar">Confirmar Pedido</button>
                </div>
                
                <div id="qr-content" style="display:none;">
                    <div class="payment-instructions">
                        <h4>✨ Pago con QR</h4>
                        <p><strong>Monto a pagar:</strong> <span id="qr-monto">Bs 0.00</span></p>
                    </div>
                    <div class="qr-code-container">
                        <img id="qr-code-img" src="" alt="Código QR">
                        <p><strong>Cuenta:</strong> 1234567890</p>
                        <p><strong>Banco:</strong> Banco Nacional</p>
                        <p><strong>Nombre:</strong> Comida Sobrante</p>
                    </div>
                    <button id="btnConfirmarQR" class="btn-pagar">Confirmar Pago</button>
                </div>
            </div>
            
            <button type="button" onclick="cerrarModalPago()" style="margin-top: 1rem; width: 100%; padding: 0.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Cancelar
            </button>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Comida Sobrante. Proyecto de Responsabilidad Social</p>
    </footer>

<script>
const API_BASE = location.hostname.includes('netlify.app') || location.hostname.includes('github.io')
    ? 'https://proyecto-comida-backend.onrender.com'
    : 'http://localhost:3000';

let sessionId = localStorage.getItem('session_id') || generateSessionId();
let carrito = null;

function mostrarMensaje(msg, tipo = 'info') {
    const d = document.createElement('div');
    d.className = `alert ${tipo}`;
    d.textContent = msg;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 4000);
}

function mostrarMensajePago(msg, tipo) {
    document.getElementById('pagoMensaje').innerHTML = `<div class="pago-mensaje ${tipo}">${msg}</div>`;
}

function generateSessionId() {
    const id = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('session_id', id);
    return id;
}

document.addEventListener('DOMContentLoaded', async () => {
    await cargarCarrito();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('btnProcederPago').addEventListener('click', procesarPago);
    ['nombreCliente', 'emailCliente'].forEach(id => {
        document.getElementById(id).addEventListener('input', validarFormulario);
    });
    window.onclick = (e) => {
        if (e.target === document.getElementById('modalPago')) cerrarModalPago();
    };
}

function validarFormulario() {
    const nombre = document.getElementById('nombreCliente').value.trim();
    const email = document.getElementById('emailCliente').value.trim();
    const items = carrito?.items?.length || 0;
    document.getElementById('btnProcederPago').disabled = !nombre || !email || items === 0;
}

async function cargarCarrito() {
    try {
        const r = await fetch(`${API_BASE}/api/carrito`, {
            headers: { 'x-session-id': sessionId }
        });
        if (!r.ok) throw new Error('Error al cargar carrito');
        carrito = await r.json();
        console.log('🛒 Carrito:', carrito);
        renderizarCarrito();
        actualizarResumen();
        validarFormulario();
    } catch (e) {
        console.error('❌', e);
        mostrarMensaje('Error al cargar carrito', 'error');
    }
}

function renderizarCarrito() {
    const c = document.getElementById('carritoItemsContainer');
    const items = carrito?.items || [];
    if (!items.length) {
        c.innerHTML = `<div class="carrito-vacio"><i>🛒</i><h3>Tu carrito está vacío</h3><a href="comida.html" class="btn-continuar-comprando">Explorar Comidas</a></div>`;
        return;
    }

    c.innerHTML = items.map(i => {
        const pu = parseFloat(i.precio_unitario || 0);
        const po = parseFloat(i.precio_original || pu * 1.5);
        const d = i.descuento_porcentaje || Math.round(((po - pu) / po) * 100);
        const st = parseFloat(i.subtotal || 0);
        
        return `<div class="carrito-item">
            <div class="item-info">
                <h4>${i.nombre}</h4>
                <div class="item-empresa"><i>🏪</i><span>${i.empresa || 'Restaurante Local'}</span></div>
                <div><span class="item-categoria">${i.categoria || 'Sin categoría'}</span>${d > 0 ? `<span class="item-descuento-badge">-${d}%</span>` : ''}</div>
                <div class="item-controles">
                    <div class="cantidad-control">
                        <button onclick="cambiarCantidad(${i.id}, ${i.cantidad - 1})">−</button>
                        <span>${i.cantidad}</span>
                        <button onclick="cambiarCantidad(${i.id}, ${i.cantidad + 1})">+</button>
                    </div>
                    <button class="btn-eliminar" onclick="eliminarItem(${i.id})">Eliminar</button>
                </div>
            </div>
            <div class="item-precio">
                ${d > 0 ? `<div class="precio-original">Bs ${po.toFixed(2)}</div>` : ''}
                <div class="precio-con-descuento">Bs ${pu.toFixed(2)} c/u</div>
                <div class="precio-total">Bs ${st.toFixed(2)}</div>
            </div>
        </div>`;
    }).join('');

    document.getElementById('cartCount').textContent = items.reduce((s, i) => s + i.cantidad, 0);
}

function actualizarResumen() {
    const st = carrito?.resumen?.subtotal || 0;
    const imp = carrito?.resumen?.impuestos || 0;
    const tot = carrito?.resumen?.total || 0;
    
    let ah = 0;
    if (carrito?.items) {
        carrito.items.forEach(i => {
            const pu = parseFloat(i.precio_unitario || 0);
            const po = parseFloat(i.precio_original || pu * 1.5);
            ah += (po - pu) * parseInt(i.cantidad || 1);
        });
    }
    
    document.getElementById('subtotal').textContent = `Bs ${st.toFixed(2)}`;
    document.getElementById('ahorro').textContent = `Bs ${ah.toFixed(2)}`;
    document.getElementById('impuestos').textContent = `Bs ${imp.toFixed(2)}`;
    document.getElementById('total').textContent = `Bs ${tot.toFixed(2)}`;
}

async function cambiarCantidad(id, cant) {
    if (cant < 1) return eliminarItem(id);
    try {
        const r = await fetch(`${API_BASE}/api/carrito/items/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'x-session-id': sessionId },
            body: JSON.stringify({ cantidad: cant })
        });
        if (!r.ok) throw new Error('Error');
        await cargarCarrito();
        mostrarMensaje('Cantidad actualizada', 'success');
    } catch (e) {
        mostrarMensaje('Error al actualizar', 'error');
    }
}

async function eliminarItem(id) {
    if (!confirm('¿Eliminar este producto?')) return;
    try {
        const r = await fetch(`${API_BASE}/api/carrito/items/${id}`, {
            method: 'DELETE',
            headers: { 'x-session-id': sessionId }
        });
        if (!r.ok) throw new Error('Error');
        await cargarCarrito();
        mostrarMensaje('Producto eliminado', 'success');
    } catch (e) {
        mostrarMensaje('Error al eliminar', 'error');
    }
}

async function procesarPago() {
    const btn = document.getElementById('btnProcederPago');
    btn.disabled = true;
    btn.textContent = 'Procesando...';
    
    try {
        if (!carrito?.items?.length) throw new Error('Carrito vacío');
        const tot = parseFloat(carrito.resumen?.total || 0);
        if (tot <= 0) throw new Error('Total inválido');

        const nom = document.getElementById('nombreCliente').value.trim();
        const em = document.getElementById('emailCliente').value.trim();
        const tel = document.getElementById('telefonoCliente').value.trim();
        const dir = document.getElementById('direccion').value.trim();
        if (!nom || !em) throw new Error('Completa los campos obligatorios');

        const met = document.querySelector('input[name="metodo_pago"]:checked')?.value || 'tarjeta';

        const r = await fetch(`${API_BASE}/api/carrito/info`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'x-session-id': sessionId },
            body: JSON.stringify({
                nombre_cliente: nom,
                email_cliente: em,
                telefono_cliente: tel || null,
                direccion: dir || null
            })
        });
        if (!r.ok) throw new Error('Error al guardar info');

        await mostrarModalPago(met, tot);
    } catch (e) {
        mostrarMensaje(e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Proceder al Pago';
    }
}

async function mostrarModalPago(met, tot) {
    const m = document.getElementById('modalPago');
    const t = document.getElementById('modalPagoTitulo');
    
    document.getElementById('tarjeta-content').style.display = 'none';
    document.getElementById('efectivo-content').style.display = 'none';
    document.getElementById('qr-content').style.display = 'none';
    document.getElementById('pagoMensaje').innerHTML = '';
    m.style.display = 'block';

    if (met === 'tarjeta') {
        t.textContent = 'Pago con Tarjeta';
        document.getElementById('tarjeta-content').style.display = 'block';
        document.getElementById('tarjeta-monto').textContent = `Bs ${tot.toFixed(2)}`;
        document.getElementById('btnConfirmarTarjeta').onclick = () => confirmarPagoTarjeta();
    } else if (met === 'efectivo') {
        t.textContent = 'Pago en Efectivo';
        document.getElementById('efectivo-content').style.display = 'block';
        document.getElementById('efectivo-monto').textContent = `Bs ${tot.toFixed(2)}`;
        document.getElementById('btnConfirmarEfectivo').onclick = () => confirmarPagoEfectivo();
    } else {
        t.textContent = 'Pago con QR';
        document.getElementById('qr-content').style.display = 'block';
        document.getElementById('qr-monto').textContent = `Bs ${tot.toFixed(2)}`;
        const qr = `Comida Sobrante|Monto: Bs ${tot.toFixed(2)}|Pedido: ${sessionId}`;
        document.getElementById('qr-code-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qr)}`;
        document.getElementById('btnConfirmarQR').onclick = () => confirmarPagoQR();
    }
}

async function confirmarPagoTarjeta() {
    const btn = document.getElementById('btnConfirmarTarjeta');
    btn.disabled = true;
    btn.textContent = '⏳ Procesando...';

    try {
        const r1 = await fetch(`${API_BASE}/api/checkout/create-payment-intent`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-session-id': sessionId }
        });
        if (!r1.ok) throw new Error((await r1.json()).mensaje || 'Error PaymentIntent');
        
        const { paymentIntentId } = await r1.json();

        const r2 = await fetch(`${API_BASE}/api/checkout/confirm`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-session-id': sessionId },
            body: JSON.stringify({ paymentIntentId })
        });
        if (!r2.ok) throw new Error((await r2.json()).mensaje || 'Error confirmar');

        mostrarMensajePago('¡Pago exitoso! ✅ Redirigiendo...', 'exito');
        localStorage.removeItem('session_id');
        setTimeout(() => window.location.href = 'pedidos.html', 2000);
    } catch (e) {
        mostrarMensajePago(`Error: ${e.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'Confirmar Pago';
    }
}

async function confirmarPagoEfectivo() {
    const btn = document.getElementById('btnConfirmarEfectivo');
    btn.disabled = true;
    btn.textContent = '⏳ Procesando...';

    try {
        const r = await fetch(`${API_BASE}/api/checkout/confirm-efectivo`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-session-id': sessionId }
        });
        if (!r.ok) throw new Error((await r.json()).mensaje || 'Error');

        mostrarMensajePago('¡Pedido confirmado! ✅ Paga al recibirlo. Redirigiendo...', 'exito');
        localStorage.removeItem('session_id');
        setTimeout(() => window.location.href = 'pedidos.html', 2000);
    } catch (e) {
        mostrarMensajePago(`Error: ${e.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'Confirmar Pedido';
    }
}

async function confirmarPagoQR() {
    const btn = document.getElementById('btnConfirmarQR');
    btn.disabled = true;
    btn.textContent = '⏳ Procesando...';

    try {
        const r = await fetch(`${API_BASE}/api/checkout/confirm-qr`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-session-id': sessionId }
        });
        if (!r.ok) throw new Error((await r.json()).mensaje || 'Error');

        mostrarMensajePago('¡Pago QR registrado! ✅ Verificaremos tu transacción. Redirigiendo...', 'exito');
        localStorage.removeItem('session_id');
        setTimeout(() => window.location.href = 'pedidos.html', 2000);
    } catch (e) {
        mostrarMensajePago(`Error: ${e.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'Confirmar Pago';
    }
}

function cerrarModalPago() {
    document.getElementById('modalPago').style.display = 'none';
}
</script>

</body>
</html>